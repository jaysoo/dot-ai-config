# Summary - November 4, 2025

## Jest Configuration Migration (jest.config.ts → jest.config.cts)

### Context
Completed migration work for Jest 30+ compatibility across all Nx packages. Jest 30+ requires CommonJS TypeScript config files (`.cts` extension with `module.exports` syntax) instead of standard `.ts` files with ESM syntax.

### Accomplishments

#### 1. Fixed JavaScript Project Jest Config Generation (Early Morning)
**File**: `packages/jest/src/generators/configuration/lib/create-files.ts`

- **Problem**: JavaScript projects (`--js` flag) were incorrectly generating `jest.config.cts` instead of `jest.config.js` because the `useCommonJsConfig` check was evaluated before the `options.js` check
- **Solution**: Reordered conditional logic to check `options.js` first, ensuring JavaScript projects get the correct file extension
- **Impact**: Fixes test failures in `@nx/node` package for `--js flag` tests

#### 2. Completed Migration for Remaining Packages (Afternoon)
Successfully migrated all remaining Nx packages that generate Jest configurations:

**@nx/nest** (Commit: 67e63a06e4)
- Updated generators to create `jest.config.cts` for TypeScript projects
- Fixed test expectations in `library.spec.ts` and `application.spec.ts`
- Updated tsconfig files to exclude both `.ts` and `.cts` for backward compatibility
- Tests: 19 suites, 78 tests passing

**@nx/express** (Commit: 67e63a06e4)
- Updated generators (delegates to @nx/node for most config)
- Fixed test expectations and snapshots
- Tests: 3 suites, 8 tests passing

**@nx/detox** (Commit: 67e63a06e4)
- Created new CommonJS template: `jest.config.cts.template`
- Removed old ESM template: `jest.config.ts.template`
- Updated `create-files.ts` generator logic
- Fixed test expectations in `application.spec.ts`
- Tests: 9 suites, 38 tests passing (1 snapshot updated)

**@nx/expo** (Commit: 67e63a06e4)
- Updated `add-jest.ts` to generate `.cts` files
- Added backward compatibility to `add-jest-resolver.ts` migration (checks all 3 extensions: `.ts`, `.cts`, `.js`)
- Updated test expectations across 3 spec files
- Tests: 10 suites, 100 tests passing (6 snapshots updated)

**@nx/react-native** (Uncommitted - ready for commit)
- Updated `add-jest.ts` to generate `jest.config.cts` instead of `.ts`
- Updated test expectations in `application.spec.ts` and `library.spec.ts`
- Tests: 14 suites, 99 tests passing (6 snapshots updated)

#### 3. Established Backward Compatibility Patterns
**Pattern Established Across All Packages**:
- **Exclude arrays** (tsconfig.lib.json): Include both `jest.config.ts` and `jest.config.cts` for backward compatibility
- **Include arrays** (tsconfig.spec.json): Only `jest.config.cts` (or `.ts` for package-level configs)
- **File generation**: Create `jest.config.cts` for TypeScript projects, `jest.config.js` for JavaScript projects
- **File existence checks**: Look for all extensions `['js', 'ts', 'cts']` when finding existing configs
- **Package-level configs**: Keep as `.ts` files (these are for testing the packages themselves, not user projects)

#### 4. Fixed Package-Level Config Confusion
**Important Distinction Clarified**:
- **User project configs** (generated by generators): Must use `.cts` for Jest 30+ compatibility
- **Package test configs** (e.g., `packages/nest/jest.config.ts`): Remain as `.ts` - these test the package itself, not user projects

### Test Results Summary
All packages passing after migration:
- ✅ **@nx/jest**: 18 suites, 236 tests
- ✅ **@nx/workspace**: 35 suites, 350 tests
- ✅ **@nx/react**: 35 suites, 461 tests
- ✅ **@nx/node**: 7 suites, 92 tests
- ✅ **@nx/remix**: Tests passing
- ✅ **@nx/next**: Tests passing (with findProjectJestConfig utility)
- ✅ **@nx/nest**: 19 suites, 78 tests
- ✅ **@nx/express**: 3 suites, 8 tests
- ✅ **@nx/detox**: 9 suites, 38 tests
- ✅ **@nx/expo**: 10 suites, 100 tests
- ✅ **@nx/react-native**: 14 suites, 99 tests

### Packages That Don't Need Migration
- ❌ **@nx/angular**: Forces Jest 29 (doesn't support Jest 30 yet) - see comment in `add-jest.ts`
- ❌ **@nx/plugin**: Delegates to @nx/js (already migrated)
- ❌ **@nx/web**: Delegates to @nx/jest (already migrated)

### Files Modified Today

**Commit 67e63a06e4** (detox, expo, nest, express):
1. `packages/detox/src/generators/application/application.spec.ts`
2. `packages/detox/src/generators/application/files/ts-solution/jest.config.cts.template` (created)
3. `packages/detox/src/generators/application/files/ts-solution/jest.config.ts.template` (deleted)
4. `packages/detox/src/generators/application/lib/create-files.ts`
5. `packages/expo/src/generators/application/application.spec.ts`
6. `packages/expo/src/generators/library/library.spec.ts`
7. `packages/expo/src/migrations/update-21-4-0/add-jest-resolver.spec.ts`
8. `packages/expo/src/migrations/update-21-4-0/add-jest-resolver.ts`
9. `packages/expo/src/utils/jest/add-jest.ts`
10. `packages/express/src/generators/application/application.spec.ts`
11. `packages/express/tsconfig.lib.json`
12. `packages/nest/src/generators/application/application.spec.ts`
13. `packages/nest/src/generators/library/__snapshots__/library.spec.ts.snap`
14. `packages/nest/src/generators/library/library.spec.ts`
15. `packages/nest/tsconfig.lib.json`
16. `packages/next/src/utils/jest-config-util.ts`
17. Multiple tsconfig.lib.json files for backward compatibility

**Uncommitted** (react-native):
1. `packages/react-native/src/generators/application/application.spec.ts`
2. `packages/react-native/src/generators/library/library.spec.ts`
3. `packages/react-native/src/utils/add-jest.ts`

### Impact
- **Ensures Jest 30+ compatibility** across all Nx packages that generate Jest configurations
- **Maintains backward compatibility** with Jest 29 by checking for both `.ts` and `.cts` extensions
- **Consistent pattern** established across 11 packages (jest, workspace, react, node, remix, next, nest, express, detox, expo, react-native)
- **Total tests passing**: 1,500+ tests across all affected packages

### Technical Learnings
1. **CommonJS requirement**: Jest 30+ requires `module.exports` syntax and `.cts` extension to guarantee CommonJS module resolution
2. **Backward compatibility strategy**: Always check all three extensions `['js', 'ts', 'cts']` when looking for existing config files
3. **Package vs user configs**: Important distinction between package-level test configs (remain `.ts`) and generated user project configs (must be `.cts`)
4. **Delegation patterns**: Many packages (plugin, web, express, nest) delegate to core packages (@nx/jest, @nx/node, @nx/js) for Jest setup
5. **Template file handling**: When creating `.cts` templates, remove all ESM syntax and conditional CommonJS checks - pure CommonJS only

### Related GitHub Issue
- Issue #32236: Invalid Jest config with Node v22.18.0
- Root cause: `__dirname` usage in ESM context requires CommonJS config files
