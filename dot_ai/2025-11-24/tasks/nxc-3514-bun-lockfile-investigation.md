# NXC-3514: Bun Binary Lockfile Parsing Error - Investigation

**Status**: ✅ RESOLVED - Third-party bug in Bun
**Issue**: https://github.com/nrwl/nx/issues/33367 (closed as not our bug)
**Linear**: https://linear.app/nxdev/issue/NXC-3514
**Root Cause**: Bun bug https://github.com/oven-sh/bun/issues/16252
**Reproduction**: https://github.com/jaysoo/bun-to-yarn-lock-invalid-file

## Resolution

The issue was caused by a bug in Bun itself, not in Nx's code. When running `bun bun.lockb` to convert the binary lockfile to Yarn v1 format, Bun outputs malformed/invalid Yarn lockfile content that the Yarn parser cannot parse, resulting in the YAML parsing error with the "*" character.

**Key Lesson**: When debugging issues where our code logic appears correct and we cannot reproduce the error, check for third-party bugs first before spending extensive time debugging our own code.

## Problem Statement

GitHub issue #33367 reports that Nx crashes when trying to parse Bun's binary lockfile (`bun.lockb`) with this error:

```
SyntaxError: Expected "\n", "\r", "\r\n", "false", "null", "true", blank space, pseudostring, or string but "*" found.
    at peg$buildStructuredError (/node_modules/@yarnpkg/parsers/lib/grammars/syml.js:371:12)
    at parseViaJsYaml (/node_modules/@yarnpkg/parsers/lib/syml.js:115:16)
    at parseSyml (/node_modules/@yarnpkg/parsers/lib/syml.js:131:12)
    at parseLockFile (/node_modules/nx/src/plugins/js/lock-file/yarn-parser.js:23:20)
    at getYarnLockfileNodes (/node_modules/nx/src/plugins/js/lock-file/yarn-parser.js:29:45)
    at getLockFileNodes (/node_modules/nx/src/plugins/js/lock-file/lock-file.js:67:63)
```

**Reported Environment**:
- Nx version: 21.6.3
- Bun version: 1.3.1
- OS: WSL2 (Linux)
- Lockfile: `bun.lockb` (binary format, 744KB)

## What We've Learned

### 1. How Bun Lockfiles Work

Bun has TWO lockfile formats:
- `bun.lock` - Text-based, Yarn v1 compatible format
- `bun.lockb` - Binary format (more compact, faster to read)

The `bun` CLI can convert binary to text:
```bash
bun bun.lockb  # Outputs Yarn v1 format to stdout
```

### 2. Nx's Lockfile Processing Flow

**Entry point**: `packages/nx/src/plugins/js/index.ts:65-68`
```typescript
const lockFileContents =
  packageManager !== 'bun'
    ? readFileSync(lockFilePath, 'utf-8')
    : readBunLockFile(lockFilePath);  // Converts binary → Yarn format
```

**Conversion function**: `packages/nx/src/plugins/js/lock-file/bun-parser.ts:147-157`
```typescript
export function readBunLockFile(lockFilePath: string): string {
  if (lockFilePath.endsWith(BUN_TEXT_LOCK_FILE)) {
    return readFileSync(lockFilePath, { encoding: 'utf-8' });
  }

  return execSync(`bun ${lockFilePath}`, {
    encoding: 'utf-8',
    maxBuffer: 1024 * 1024 * 10,
    windowsHide: false,
  });
}
```

**Parser routing**: `packages/nx/src/plugins/js/lock-file/lock-file.ts:94-107`
```typescript
if (packageManager === 'bun') {
  const lockFilePath = getLockFilePath(packageManager);
  if (lockFilePath.endsWith(BUN_TEXT_LOCK_FILE)) {
    // Use new text-based parser (added in commit e5ef717a63)
    const nodes = getBunTextLockfileNodes(contents, lockFileHash);
    return { nodes, keyMap: new Map() };
  } else {
    // Fallback to yarn parser for binary format
    const packageJson = readJsonFile(
      join(context.workspaceRoot, 'package.json')
    );
    return getYarnLockfileNodes(contents, lockFileHash, packageJson);
  }
}
```

### 3. Historical Context

**Before commit e5ef717a63** (July 28, 2025):
- ALL Bun lockfiles → Yarn parser
- Comment in code: "bun uses yarn v1 for the file format"

**After commit e5ef717a63** (current master):
- Text `bun.lock` → New Bun text parser (parses JSON format)
- Binary `bun.lockb` → Yarn parser (should work because `bun bun.lockb` outputs Yarn v1 format)

### 4. Testing Results

#### Test 1: Manual lockfile parsing in `/tmp/bun1`
```bash
cd /tmp/bun1
node -e "
const {readBunLockFile} = require('./node_modules/nx/src/plugins/js/lock-file/bun-parser.js');
const contents = readBunLockFile('./bun.lockb');
console.log(contents.substring(0, 100));
"
```

**Result**:
```
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1
# bun ./bun.lock
```

✅ `readBunLockFile()` correctly converts binary → Yarn v1 format

#### Test 2: Full Nx workflow in `/tmp/bun1`
```bash
cd /tmp/bun1
rm -rf .nx/workspace-data/
env NX_DAEMON=false NX_CACHE_PROJECT_GRAPH=false nx report
```

**Result**: ✅ No errors! Works perfectly.

## The Mystery

**Why can't we reproduce the error?**

The issue reporter says they get a Yarn parser error, but:
1. `readBunLockFile()` correctly converts binary → Yarn format
2. The Yarn parser should handle Yarn format correctly
3. Our test repo (`/tmp/bun1`) with binary `bun.lockb` works fine

**Possible explanations:**

1. **Bun version difference**:
   - Reporter has Bun 1.3.1 (from 2024)
   - Test repo has Bun 1.3.2 (current)
   - Maybe older Bun versions output malformed Yarn format?

2. **Specific lockfile content**:
   - The reporter's lockfile is 744KB (very large)
   - Maybe has specific packages/versions that trigger parsing errors
   - The "*" character mentioned in error suggests specific package names/versions

3. **Environment differences**:
   - Reporter uses WSL2 (Linux on Windows)
   - Test uses macOS
   - Different line endings or shell behavior?

4. **Nx plugin not loading**:
   - The `nx/js/dependencies-and-lockfile` plugin might not be loading in reporter's setup
   - But then they wouldn't get the error...

5. **Race condition or timing issue**:
   - Daemon vs non-daemon behavior
   - Cache corruption
   - File system watching issues

## Next Steps to Reproduce

### Option 1: Get the actual failing lockfile
- Ask the issue reporter to share their `bun.lockb` file
- Or share their full repo setup (dependencies in package.json)
- Test with their exact setup

### Option 2: Test with older Bun versions
```bash
# Install Bun 1.3.1 (same as reporter)
curl -fsSL https://bun.sh/install | bash -s "bun-v1.3.1"

# Create workspace and test
npx create-nx-workspace@21.6.3 test-bun-old \
  --preset=node-monorepo \
  --packageManager=bun \
  --no-interactive

cd test-bun-old
rm -rf .nx
nx report
```

### Option 3: Test with large/complex dependencies
Create a workspace with many dependencies (similar to 744KB lockfile):
- Add 50-100 popular npm packages
- Use packages with special characters in names
- Use packages with "*" in their metadata

### Option 4: Check if it's a WSL2-specific issue
- Test in Linux environment (Docker or actual Linux machine)
- Test specifically in WSL2 if possible

### Option 5: Add debug logging
Modify `node_modules/nx/src/plugins/js/lock-file/lock-file.js` to log:
- What content is being passed to parsers
- Which code path is taken
- What the lockFilePath value is

## Code Paths to Investigate

1. **Is `readBunLockFile()` always called?**
   - Check if there's a code path that reads the binary file directly
   - Maybe daemon vs non-daemon has different behavior?

2. **Does the Yarn parser handle all valid Yarn v1 formats?**
   - Maybe `bun bun.lockb` outputs valid Yarn but with edge cases
   - The "*" character in error suggests version ranges or globs

3. **Is there a race condition?**
   - File being read while being written?
   - Cache corruption between runs?

## Files Modified (Now Reverted)

- `packages/nx/src/plugins/js/lock-file/lock-file.ts` - Attempted fix (reverted)
- `packages/nx/src/plugins/js/lock-file/lock-file.spec.ts` - Test file (deleted)

All changes have been reverted. Working tree is clean.

## Key Insight from Investigation

**The current code SHOULD work** because:
1. `readBunLockFile()` converts binary → Yarn v1 format
2. Yarn parser handles Yarn v1 format
3. Test repos confirm this works

**Therefore**: We need to find what's different about the reporter's environment or lockfile that causes the failure.

## Action Items

1. ⬜ Ask issue reporter for their exact `bun.lockb` file or full repo
2. ⬜ Test with Bun 1.3.1 (reporter's version) instead of 1.3.2
3. ⬜ Create workspace with 50-100 dependencies to get large lockfile
4. ⬜ Test in WSL2 environment
5. ⬜ Add debug logging to understand what content is being parsed
6. ⬜ Check if there are any environment variables affecting behavior
7. ⬜ Test with daemon enabled vs disabled
8. ⬜ Check if issue is intermittent (timing/race condition)
