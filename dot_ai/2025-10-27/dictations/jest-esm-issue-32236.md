# TODO: Jest Config ESM Issue

**Issue:** https://github.com/nrwl/nx/issues/32236

**Priority:** High

## Summary

Jest configuration files generated by Nx contain usage of `__dirname`, which is not valid in an ESM context. This causes tests to fail out of the box when using:
- Node v22.18.0 or above (type stripping enabled by default)
- Nx v21.3+ (which includes Jest v30)
- Jest v30 (uses native type-stripping instead of ts-node loader)

## Root Cause

The problem stems from three converging changes:

1. **Nx's default Jest config** uses `__dirname` (CommonJS only)
2. **Jest v30** (introduced in Nx v21.3) now uses native type-stripping when supported by Node
3. **Node v22.18.0+** enabled type stripping by default

Previously, Jest used the `ts-node` loader to parse config files, which worked with Nx's current workaround (see [jest.impl.ts:L24-32](https://github.com/nrwl/nx/blob/334d74ea1cdeb29312eb423227952cf4391f088d/packages/jest/src/executors/jest/jest.impl.ts#L24-L32)). But Jest v30's native type-stripping bypasses this loader.

## Error

```
ReferenceError: __dirname is not defined in ES module scope
  at readConfigFileAndSetRootDir
```

## Expected Behavior

Tests should succeed by default out of the box with any supported Node version.

## Reproduction

Repo: https://github.com/estiller/nx-jest-config

Steps:
1. Create new workspace with Jest using `pnpm create nx-workspace@latest`
2. Use Node v22.18.0+ (e.g., `nvm use 22.18.0`)
3. Run `pnpm nx run-many -t test --skip-nx-cache`
4. Tests fail with `__dirname` error

## Labels

- `type: bug`
- `scope: testing tools`
- `priority: high` (affects many people severely)

## Notes

This is a Jest configuration issue specifically related to ESM module problems in newer Node versions. The fix likely requires updating the default Jest config template that Nx generates to use ESM-compatible alternatives to `__dirname`.

Related Jest changes:
- [Jest v30 changelog](https://github.com/jestjs/jest/releases/tag/v30.0.0)
- [Native type-stripping PR](https://github.com/jestjs/jest/pull/15480)
- [Node v22.18.0 release notes](https://github.com/nodejs/node/releases/tag/v22.18.0)
